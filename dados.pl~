
%Reta de X -> Mandaguari.
reta('Mandaguari', 'Mandaguari', 0).
reta('Jandaia', 'Mandaguari', 10).
reta('Marialva', 'Mandaguari', 11).
reta('Sarandi', 'Mandaguari', 20).
reta('Maringa', 'Mandaguari', 27).
reta('Cambira', 'Mandaguari', 13).
reta('Apucarana', 'Mandaguari', 23).
reta('Arapongas', 'Mandaguari', 28).
reta('Cambe', 'Mandaguari', 49).
reta('Londrina', 'Mandaguari', 57).
reta('Paranavai', 'Mandaguari', 92).
reta('Campo Mourao', 'Mandaguari', 91).
reta('Toledo', 'Mandaguari', 248).
reta('Pato Branco', 'Mandaguari', 317).
reta('Guarapuava', 'Mandaguari', 209).
reta('Cascavel', 'Mandaguari', 241).
reta('Astorga', 'Mandaguari', 30).
reta('Umuarama', 'Mandaguari', 168).
reta('Ponta Grossa', 'Mandaguari', 234).
reta('Curitiba', 'Mandaguari', 324).

%Reta X -> Jandaia
reta('Jandaia', 'Jandaia', 0).
reta('Marialva', 'Jandaia', 20).
reta('Sarandi', 'Jandaia', 30).
reta('Maringa', 'Jandaia', 36).
reta('Cambira', 'Jandaia', 6).
reta('Apucarana', 'Jandaia', 19).
reta('Arapongas', 'Jandaia', 30).
reta('Cambe', 'Jandaia', 51).
reta('Londrina', 'Jandaia', 58).
reta('Paranavai', 'Jandaia', 102).
reta('Campo Mourao', 'Jandaia', 90).
reta('Toledo', 'Jandaia', 248).
reta('Pato Branco', 'Jandaia', 311).
reta('Guarapuava', 'Jandaia', 200).
reta('Cascavel', 'Jandaia', 239).
reta('Astorga', 'Jandaia', 40).
reta('Umuarama', 'Jandaia', 172).
reta('Ponta Grossa', 'Jandaia', 224).
reta('Curitiba', 'Jandaia', 315).

%Reta X -> Marialva
reta('Marialva', 'Marialva', 0).
reta('Sarandi', 'Marialva', 10).
reta('Maringa', 'Marialva', 16).
reta('Cambira', 'Marialva', 25).
reta('Apucarana', 'Marialva', 34).
reta('Arapongas', 'Marialva', 38).
reta('Cambe', 'Marialva', 57).
reta('Londrina', 'Marialva', 67).
reta('Paranavai', 'Marialva', 82).
reta('Campo Mourao', 'Marialva', 86).
reta('Toledo', 'Marialva', 241).
reta('Pato Branco', 'Marialva', 318).
reta('Guarapuava', 'Marialva', 215).
reta('Cascavel', 'Marialva', 236).
reta('Astorga', 'Marialva', 30).
reta('Umuarama', 'Marialva', 159).
reta('Ponta Grossa', 'Marialva', 245).
reta('Curitiba', 'Marialva', 336).

%Reta X -> Sarandi
reta('Sarandi', 'Sarandi', 0).
reta('Maringa', 'Sarandi', 6).
reta('Cambira', 'Sarandi', 34).
reta('Apucarana', 'Sarandi', 44).
reta('Arapongas', 'Sarandi', 46).
reta('Cambe', 'Sarandi', 64).
reta('Londrina', 'Sarandi', 74).
reta('Paranavai', 'Sarandi', 72).
reta('Campo Mourao', 'Sarandi', 84).
reta('Toledo', 'Sarandi', 237).
reta('Pato Branco', 'Sarandi', 320).
reta('Guarapuava', 'Sarandi', 221).
reta('Cascavel', 'Sarandi', 233).
reta('Astorga', 'Sarandi', 31).
reta('Umuarama', 'Sarandi', 152).
reta('Ponta Grossa', 'Sarandi', 254).
reta('Curitiba', 'Sarandi', 345).


%Reta X -> Maringa
reta('Maringa', 'Maringa', 0).
reta('Cambira', 'Maringa', 41).
reta('Apucarana', 'Maringa', 50).
reta('Arapongas', 'Maringa', 52).
reta('Cambe', 'Maringa', 69).
reta('Londrina', 'Maringa', 79).
reta('Paranavai', 'Maringa', 66).
reta('Campo Mourao', 'Maringa', 83).
reta('Toledo', 'Maringa', 234).
reta('Pato Branco', 'Maringa', 321).
reta('Guarapuava', 'Maringa', 224).
reta('Cascavel', 'Maringa', 231).
reta('Astorga', 'Maringa', 34).
reta('Umuarama', 'Maringa', 147).
reta('Ponta Grossa', 'Maringa', 260).
reta('Curitiba', 'Maringa', 351).

%Reta X -> Cambira
reta('Cambira', 'Cambira', 0).
reta('Apucarana', 'Cambira', 13).
reta('Arapongas', 'Cambira', 25).
reta('Cambe', 'Cambira', 46).
reta('Londrina', 'Cambira', 53).
reta('Paranavai', 'Cambira', 106).
reta('Campo Mourao', 'Cambira', 96).
reta('Toledo', 'Cambira', 254).
reta('Pato Branco', 'Cambira', 314).
reta('Guarapuava', 'Cambira', 201).
reta('Cascavel', 'Cambira', 244).
reta('Astorga', 'Cambira', 40).
reta('Umuarama', 'Cambira', 179).
reta('Ponta Grossa', 'Cambira', 221).
reta('Curitiba', 'Cambira', 311).

%Reta X -> Apucarana
reta('Apucarana', 'Apucarana', 0).
reta('Arapongas', 'Apucarana', 15).
reta('Cambe', 'Apucarana', 36).
reta('Londrina', 'Apucarana', 41).
reta('Paranavai', 'Apucarana', 115).
reta('Campo Mourao', 'Apucarana', 108).
reta('Toledo', 'Apucarana', 266).
reta('Pato Branco', 'Apucarana', 322).
reta('Guarapuava', 'Apucarana', 205).
reta('Cascavel', 'Apucarana', 256).
reta('Astorga', 'Apucarana', 40).
reta('Umuarama', 'Apucarana', 191).
reta('Ponta Grossa', 'Apucarana', 217).
reta('Curitiba', 'Apucarana', 305).

%Reta X -> Arapongas
reta('Arapongas', 'Arapongas', 0).
reta('Cambe', 'Arapongas', 21).
reta('Londrina', 'Arapongas', 29).
reta('Paranavai', 'Arapongas', 112).
reta('Campo Mourao', 'Arapongas', 120).
reta('Toledo', 'Arapongas', 277).
reta('Pato Branco', 'Arapongas', 338).
reta('Guarapuava', 'Arapongas', 220).
reta('Cascavel', 'Arapongas', 268).
reta('Astorga', 'Arapongas', 31).
reta('Umuarama', 'Arapongas', 197).
reta('Ponta Grossa', 'Arapongas', 227).
reta('Curitiba', 'Arapongas', 313).

%Reta X -> Cambe
reta('Cambe', 'Cambe', 0).
reta('Londrina', 'Cambe', 12).
reta('Paranavai', 'Cambe', 123).
reta('Campo Mourao', 'Cambe', 141).
reta('Toledo', 'Cambe', 298).
reta('Pato Branco', 'Cambe', 357).
reta('Guarapuava', 'Cambe', 236).
reta('Cascavel', 'Cambe', 290).
reta('Astorga', 'Cambe', 39).
reta('Umuarama', 'Cambe', 215).
reta('Ponta Grossa', 'Cambe', 233).
reta('Curitiba', 'Cambe', 315).

%Reta X -> Londrina
reta('Londrina', 'Londrina', 0).
reta('Paranavai', 'Londrina', 135).
reta('Campo Mourao', 'Londrina', 148).
reta('Toledo', 'Londrina', 306).
reta('Pato Branco', 'Londrina', 359).
reta('Guarapuava', 'Londrina', 234).
reta('Cascavel', 'Londrina', 297).
reta('Astorga', 'Londrina', 51).
reta('Umuarama', 'Londrina', 225).
reta('Ponta Grossa', 'Londrina', 225).
reta('Curitiba', 'Londrina', 305).

%Reta X -> Paranavai
reta('Paranavai', 'Paranavai', 0).
reta('Campo Mourao', 'Paranavai', 107).
reta('Toledo', 'Paranavai', 225).
reta('Pato Branco', 'Paranavai', 351).
reta('Guarapuava', 'Paranavai', 276).
reta('Cascavel', 'Paranavai', 232).
reta('Astorga', 'Paranavai', 84).
reta('Umuarama', 'Paranavai', 116).
reta('Ponta Grossa', 'Paranavai', 324).
reta('Curitiba', 'Paranavai', 416).

%Reta X -> Campo Mourao
reta('Campo Mourao', 'Campo Mourao', 0).
reta('Toledo', 'Campo Mourao', 158).
reta('Pato Branco', 'Campo Mourao', 245).
reta('Guarapuava', 'Campo Mourao', 176).
reta('Cascavel', 'Campo Mourao', 150).
reta('Astorga', 'Campo Mourao', 115).
reta('Umuarama', 'Campo Mourao', 101).
reta('Ponta Grossa', 'Campo Mourao', 254).
reta('Curitiba', 'Campo Mourao', 350).

%Reta X -> Toledo
reta('Toledo', 'Toledo', 0).
reta('Pato Branco', 'Toledo', 199).
reta('Guarapuava', 'Toledo', 241).
reta('Cascavel', 'Toledo', 39).
reta('Astorga', 'Toledo', 268).
reta('Umuarama', 'Toledo', 114).
reta('Ponta Grossa', 'Toledo', 364).
reta('Curitiba', 'Toledo', 458).

%Reta X -> Pato Branco
reta('Pato Branco', 'Pato Branco', 0).
reta('Guarapuava', 'Pato Branco', 153).
reta('Cascavel', 'Pato Branco', 162).
reta('Astorga', 'Pato Branco', 348).
reta('Umuarama', 'Pato Branco', 282).
reta('Ponta Grossa', 'Pato Branco', 282).
reta('Curitiba', 'Pato Branco', 353).

%Reta X -> Guarapuava
reta('Guarapuava', 'Guarapuava', 0).
reta('Cascavel', 'Guarapuava', 207).
reta('Astorga', 'Guarapuava', 240).
reta('Umuarama', 'Guarapuava', 261).
reta('Ponta Grossa', 'Guarapuava', 135).
reta('Curitiba', 'Guarapuava', 221).

%Reta X -> Cascavel
reta('Cascavel', 'Cascavel', 0).
reta('Astorga', 'Cascavel', 264).
reta('Umuarama', 'Cascavel', 133).
reta('Ponta Grossa', 'Cascavel', 406).
reta('Curitiba', 'Cascavel', 425).

%Reta X -> Astorga
reta('Astorga', 'Astorga', 0).
reta('Umuarama', 'Astorga', 179).
reta('Ponta Grossa', 'Astorga', 257).
reta('Curitiba', 'Astorga', 344).

%Reta X -> Umuarama
reta('Umuarama', 'Umuarama', 0).
reta('Ponta Grossa', 'Umuarama', 353).
reta('Curitiba', 'Umuarama', 450).

%Reta X -> Ponta Grossa
reta('Ponta Grossa', 'Ponta Grossa', 0).
reta('Curitiba', 'Ponta Grossa', 97).

%Reta X -> Curitiba
reta('Curitiba', 'Curitiba', 0).

%%dados_via(cod, orig, dest, dist, caracter(piso, pedagio, velmedia)).
dados_via(1, 'Mandaguari', 'Jandaia', 11, caracteristicas(4, 0, 80)).
dados_via(2, 'Jandaia', 'Cambira', 16, caracteristicas(2, 0, 70)).
dados_via(3, 'Cambira', 'Apucarana', 16, caracteristicas(1, 0, 50)).
dados_via(4, 'Apucarana', 'Arapongas', 17, caracteristicas(3, 0, 70)).
dados_via(5, 'Mandaguari', 'Arapongas', 37, caracteristicas(3, 0, 85)).
dados_via(6, 'Arapongas', 'Cambe', 24, caracteristicas(3, 0, 80)).
dados_via(7, 'Cambe', 'Londrina', 13, caracteristicas(4, 8, 70)).
dados_via(8, 'Cambe', 'Astorga', 52, caracteristicas(2, 5, 75)).
dados_via(9, 'Astorga', 'Maringa', 52, caracteristicas(3, 0, 100)).
dados_via(10, 'Maringa', 'Paranavai', 74, caracteristicas(3, 0, 90)).
dados_via(11, 'Maringa', 'Sarandi', 7, caracteristicas(3, 0, 65)).
dados_via(12, 'Sarandi', 'Marialva', 10, caracteristicas(3, 0, 90)).
dados_via(13, 'Marialva', 'Mandaguari', 11, caracteristicas(4, 7, 100)).
dados_via(14, 'Apucarana', 'Ponta Grossa', 251, caracteristicas(2, 0, 70)).
dados_via(15, 'Maringa', 'Umuarama', 165, caracteristicas(3, 0, 82)).
dados_via(16, 'Maringa', 'Campo Mourao', 91, caracteristicas(3, 10, 80)).
dados_via(17, 'Campo Mourao', 'Toledo', 220, caracteristicas(1, 5, 88)).
dados_via(18, 'Umuarama', 'Toledo', 130, caracteristicas(1, 0, 100)).
dados_via(19, 'Toledo', 'Cascavel', 45, caracteristicas(3, 5, 95)).
dados_via(20, 'Cascavel', 'Pato Branco', 234, caracteristicas(5, 10, 110)).
dados_via(21, 'Pato Branco', 'Guarapuava', 187, caracteristicas(4, 8, 99)).
dados_via(22, 'Guarapuava', 'Ponta Grossa', 163, caracteristicas(3, 5, 80)).
dados_via(23, 'Ponta Grossa', 'Curitiba', 116, caracteristicas(4, 8, 85)).

listar_cidade(Lista) :-
	setof(X, A^B^C^Y^dados_via(A, X, Y, B, C), Lista1),
	setof(X, A^B^C^Y^dados_via(A, Y, X, B, C), Lista2),
	union(Lista1, Lista2, Lista).

obter_reta(Origem, Destino, Reta):-
	reta(Origem, Destino, Reta), !.

obter_reta(Origem, Destino, Reta):-
	!, reta(Destino, Origem, Reta).

pai(Cidade, [[Cidade, Custo, Pai] | _], [Cidade, Custo, Pai]) :- !.
pai(Cidade, [_|Resto], Pai) :- pai(Cidade, Resto, Pai).

reconstruirCaminho(_, [Cidade, _, null], [Cidade]).
reconstruirCaminho(Fechados, Vertice, [Cidade|Resto]) :-
	[Cidade, _, Pai] = Vertice,
	pai(Pai, Fechados, PaiNovo),
	reconstruirCaminho(Fechados, PaiNovo, Resto).

%Busca o menor caminho
encontrarCaminho(Origem, Destino, Caminho, Custo):-
	a_estrela([[Origem, 0, null]], [], Destino, Fechados), %inicia apenas com origem.
	last(Fechados, Ultimo),
	reconstruirCaminho(Fechados, Ultimo, CaminhoInvertido),
	reverse(CaminhoInvertido, Caminho),
	[_,Custo,_] = Ultimo, !.

% Quando não exite caminho
encontrarCaminho(_, _, _, _):- fail.

%a_estrela(Abertos, Fechados, Destino, Caminho).
% Abertos e Fechados é uma lista de vértices
%[Vertice, Custo, Pai]

%caso de Abertos ser vazio, não tem solução
a_estrela([], _, _, _) :- fail.

%caso de achar o destino
a_estrela(Abertos, Fechados, Destino, Caminho) :-
	melhor_vertice(Abertos, V, Destino),
	nth0(0, V, X), %pega a cidade
        ( X == Destino -> %achou caminho
	 append(Fechados, [V], Fechado2),
	 Caminho = Fechado2;
	%else
	delete(Abertos, V, Abertos2),
	append(Fechados, [V], Fechados2),
	atualizarAdjacentes(Abertos2, Fechados2, V, NovoAbertos),
	a_estrela(NovoAbertos, Fechados2, Destino, Caminho)).


atualizarAdjacentes(Abertos, Fechados, [Cidade, Custo, _], NovoAbertos) :-
	findall(
	    [Cidade2, S, Cidade],
	    (verificaDistancia(Cidade, Cidade2, Distancia),
	     S is Distancia+Custo, custo(Cidade2, Abertos, CustoAntigo), S < CustoAntigo,
	     not(member([Cidade2, _, _], Fechados))),
	    Adjacentes),
	deletarRepetidos(Abertos, Adjacentes, Abertos2),
	union(Abertos2, Adjacentes, NovoAbertos).


deletarRepetidos(Abertos, [], Abertos) :- !.
deletarRepetidos(Abertos, [[Cidade, _, _]|Resto], Novo) :-
	delete(Abertos, [Cidade,_,_], Abertos2),
	deletarRepetidos(Abertos2, Resto, Novo).


custo(_, [], 100000000) :- !.
custo(Cidade, [[Cidade, Custo, _] | _], Custo) :- !.
custo(Cidade, [_|Resto], Custo) :- custo(Cidade, Resto, Custo).


%Retorna o melhor vértice
melhor_vertice([X],X,_):- !.
%Caso: Pegar o caminho 1
melhor_vertice([[Cidade1,Custo1|Resto1],[Cidade2, Custo2|_]|Resto], MelhorVertice, Destino):-
	obter_reta(Cidade1, Destino, Heuristica1),
	obter_reta(Cidade2, Destino, Heuristica2),
	Heuristica1 +  Custo1 =< Heuristica2 +  Custo2,
	melhor_vertice([[Cidade1,Custo1|Resto1]|Resto], MelhorVertice, Destino).

%Caso: Pegar o caminho 2
melhor_vertice([[Cidade1,Custo1|_],[Cidade2,Custo2|Resto2]|Resto], MelhorVertice, Destino):-
	obter_reta(Cidade1, Destino, Heuristica1),
	obter_reta(Cidade2, Destino, Heuristica2),
	Heuristica1  + Custo1 > Heuristica2 +  Custo2,
	melhor_vertice([[Cidade2,Custo2|Resto2]|Resto], MelhorVertice, Destino).


verificaDistancia(Origem, Destino, Distancia):-
	dados_via(_,Origem, Destino, Distancia, _).
verificaDistancia(Origem, Destino, Distancia):-
	dados_via(_, Destino, Origem, Distancia, _).

kesimo([X | _], 0, X) :- !.
kesimo([_ | XS], K, X) :-
	K > 0,
	K0 is K - 1,
	kesimo(XS, K0, X).

%testa Todos os Caminhos de X para Y
teste(Caminho, Custo) :-
	dados_via(_, X, _, _, _),
	%dados_via(_, _, Y, _, _),
	encontrarCaminho(X, 'Curitiba', Caminho, Custo).

